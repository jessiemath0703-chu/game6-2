<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jessie Math - åŸºæº–é‡å¤§å†’éšª</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Fredoka+One&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* å“ç‰Œè‰²ç³» */
            --brand-primary: #2c3e50; 
            --brand-accent: #e67e22;  
            --brand-purple: #6c5ce7; 
            --icon-blue: #4285f4;     
            --bg-color: #f0f2f5;
            --correct: #27ae60;
            --wrong: #c0392b;
            --hud-time: #e74c3c;
            --hud-score: #f1c40f;
        }

        * { box-sizing: border-box; }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            display: flex; flex-direction: column;
            overflow-y: auto; overflow-x: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* --- 1. Header å°è¦½åˆ— --- */
        header {
            height: 70px;
            background: white;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
            flex-shrink: 0;
            border-bottom: 1px solid #eee;
        }

        .brand-group {
            display: flex; align-items: center; gap: 10px; text-decoration: none;
        }

        .avatar-circle {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 3px solid var(--brand-accent);
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background: #fff; flex-shrink: 0;
        }
        
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }

        .brand-text {
            font-family: 'Fredoka One', cursive, sans-serif;
            font-size: 22px; 
            color: var(--brand-primary); 
            letter-spacing: 0.5px;
            font-weight: 900;
        }

        .nav-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            text-decoration: none;
            color: #5f6368;
            background: white;
            border: 1px solid #dadce0;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: bold;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .nav-btn i { color: var(--icon-blue); font-size: 1rem; }
        .nav-btn:hover { background-color: #f8f9fa; transform: translateY(-1px); }

        .nav-btn-purple {
            color: var(--brand-purple);
            border: 1.5px solid var(--brand-purple);
            background: #f8f7ff;
        }
        .nav-btn-purple i { color: var(--brand-purple); }
        .nav-btn-purple:hover {
            background: var(--brand-purple);
            color: white;
        }
        .nav-btn-purple:hover i { color: white; }

        @media (max-width: 600px) {
            .brand-text { display: none; } 
            .nav-btn span { font-size: 12px; }
            .nav-btn { padding: 6px 10px; }
        }

        /* --- 2. éŠæˆ²ä¸»å€åŸŸ --- */
        #game-container {
            flex: 1; display: flex; justify-content: center; align-items: center;
            padding: 10px; width: 100%; position: relative;
        }

        .game-box {
            width: 100%; max-width: 800px; background: white; 
            border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 20px; position: relative; min-height: 550px; 
            display: flex; flex-direction: column;
            overflow: hidden; 
        }

        /* --- Overlays --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); border-radius: 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; text-align: center; padding: 20px;
        }
        .hidden { display: none !important; }

        h1 { color: var(--brand-primary); font-size: 2.2rem; margin-bottom: 15px; line-height: 1.2; }
        p { color: #666; font-size: 1rem; margin-bottom: 20px; font-weight: bold;}

        input[type="text"] {
            padding: 10px; font-size: 1.2rem;
            border: 3px solid #ddd; border-radius: 50px;
            text-align: center; width: 80%; max-width: 250px; margin-bottom: 20px;
            font-weight: bold; color: var(--brand-primary);
        }
        input:focus { border-color: var(--brand-accent); outline: none; }

        .btn {
            background: var(--brand-accent); color: white; border: none;
            /* èª¿æ•´ padding èˆ‡ max-width è®“æ–‡å­—ä¸æ›è¡Œ */
            padding: 12px 20px; 
            font-size: 1.2rem; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 0 #d35400; transition: 0.1s; font-weight: bold; margin: 8px;
            width: 100%; max-width: 320px; /* åŠ å¯¬æŒ‰éˆ• */
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-blue { background: var(--brand-primary); box-shadow: 0 4px 0 #1a252f; }
        .btn-green { background: var(--correct); box-shadow: 0 4px 0 #1e8449; } 

        .pause-btn-top {
            position: absolute; top: 15px; right: 15px;
            width: 40px; height: 40px; border-radius: 50%;
            background: #f1f2f6; border: 2px solid #ddd; color: #555;
            font-size: 1.2rem; cursor: pointer; z-index: 40;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .pause-btn-top:hover { background: #e1e2e6; color: var(--brand-primary); }

        /* --- HUD --- */
        .hud {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;
            margin-bottom: 10px; margin-top: 10px;
        }
        .hud-group { display: flex; gap: 15px; }
        .hud-item { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .hud-label { font-size: 0.8rem; color: #999; font-weight: bold; }
        .hud-value { font-size: 1.8rem; font-weight: 900; line-height: 1; }
        #time-disp { color: var(--hud-time); font-family: monospace; }
        #score-disp { color: var(--hud-score); }
        
        .combo-box {
            background: linear-gradient(135deg, #FF9966, #FF5E62);
            color: white; padding: 5px 15px; border-radius: 20px;
            font-weight: 900; font-size: 1.2rem; 
            opacity: 0; transform: scale(0.5); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 10px rgba(255, 94, 98, 0.4);
        }
        .combo-active { opacity: 1; transform: scale(1); animation: bounce 0.5s; }

        /* --- Scenario Card (æƒ…å¢ƒæ’åœ–å„ªåŒ–) --- */
        .scenario-card {
            background: linear-gradient(to bottom, #fdfbfb 0%, #ebedee 100%);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            border: 2px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }
        /* èƒŒæ™¯æ”¹æˆå¤©å¹³åœ–ç¤ºï¼Œæ›´ç¬¦åˆåŸºæº–é‡ä¸»é¡Œ */
        .scenario-bg {
            position: absolute; opacity: 0.08; font-size: 7rem;
            transform: rotate(-10deg); color: var(--brand-primary);
        }
        /* æ–°å¢å½ˆå‡ºå‹•ç•« */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- Question & Interaction --- */
        .question-area {
            font-size: 1.3rem; font-weight: 900; text-align: center; 
            color: var(--brand-primary); margin-bottom: 10px;
            line-height: 1.5;
        }
        .highlight { color: #d81b60; text-decoration: underline; text-decoration-thickness: 3px;}

        .hint-text {
            text-align: center; color: #7f8c8d; font-weight: bold; 
            margin-bottom: 15px; min-height: 1.2em; font-size: 1rem;
        }

        .stage {
            flex: 1; display: flex; justify-content: space-around; align-items: flex-end;
            border-bottom: 4px solid #eee; margin-bottom: 15px; padding-bottom: 5px;
            min-height: 180px; position: relative;
        }

        .char-box {
            display: flex; flex-direction: column; align-items: center;
            width: 100px; cursor: pointer; position: relative; transition: transform 0.2s;
        }
        .char-box:active { transform: scale(0.95); }
        .char-box.locked { cursor: default; opacity: 1; }
        .char-box.dimmed { opacity: 0.4; }

        .bar-model {
            width: 60px; height: 50px; background: #bdc3c7;
            border-radius: 10px 10px 0 0; display: flex; justify-content: center; align-items: center;
            font-size: 30px; color: white; transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1), background 0.3s;
            position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .crown {
            position: absolute; top: -35px; font-size: 24px;
            display: none; animation: bounce 0.6s infinite alternate; z-index: 10;
        }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-8px); } }

        .char-name {
            margin-top: 10px; background: #fff; padding: 5px 15px; border: 2px solid #eee;
            border-radius: 20px; font-weight: bold; color: var(--brand-primary); font-size: 0.9rem;
        }

        /* --- Slider Controls --- */
        .control-panel {
            background: #fff3e0; padding: 10px; border-radius: 12px;
            text-align: center; border: 2px dashed var(--brand-accent); display: none;
            margin-top: auto; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        input[type=range] {
            width: 90%; margin: 15px 0; -webkit-appearance: none;
            height: 12px; background: #ddd; border-radius: 10px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 28px; height: 28px;
            background: var(--brand-accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white;
        }
        .val-display { font-size: 1.8rem; font-weight: 900; color: var(--brand-accent); margin-left: 5px; vertical-align: middle; }

        /* --- Stars & Rank --- */
        .stars-container { font-size: 3rem; color: #ddd; margin: 10px 0; }
        .star.active { color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        
        .rank-list {
            width: 100%; max-width: 400px; text-align: left; margin-top: 10px;
            border: 2px solid #eee; border-radius: 10px; overflow-y: auto; max-height: 150px;
            background: #fafafa; margin-bottom: 10px;
        }
        .rank-item {
            display: flex; justify-content: space-between; padding: 8px 12px;
            border-bottom: 1px solid #eee; color: var(--brand-primary); font-weight: bold; font-size: 0.9rem;
        }
        
        .urgent { color: red !important; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <header>
        <a href="https://jessiemath0703-chu.github.io/website2/" class="brand-group">
            <div class="avatar-circle">
                <img src="JESSIEMATH-Q.png" alt="J" onerror="this.src='https://ui-avatars.com/api/?name=JM&background=e67e22&color=fff'">
            </div>
            <span class="brand-text">Jessie Math</span>
        </a>

        <div class="nav-group">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn">
                <i class="fas fa-home"></i> <span>é¦–é </span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn">
                <i class="fas fa-gamepad"></i> <span>éŠæˆ²å¤§å»³</span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn nav-btn-purple">
                <i class="fas fa-undo"></i> <span>å…­å¹´ç´šåŸºæº–é‡èˆ‡æ¯”è¼ƒé‡</span>
            </a>
        </div>
    </header>

    <div id="game-container">
        <div class="game-box">

            <button class="pause-btn-top hidden" id="btn-pause" onclick="game.togglePause()">
                <i class="fas fa-pause"></i>
            </button>

            <div id="screen-start" class="overlay">
                <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ§ª</div>
                <h1>åŸºæº–é‡å¤§å†’éšª</h1>
                <p>è¼¸å…¥ä»£è™Ÿï¼Œ60ç§’æ¥µé™æŒ‘æˆ°ï¼</p>
                <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥åå­—" maxlength="8">
                <button class="btn" onclick="game.goToLevelSelect()">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
                
                <div style="width:100%; max-width:400px; margin-top:20px;">
                    <p style="color:var(--brand-accent); margin-bottom:5px; font-size:1rem;"><i class="fas fa-trophy"></i> æ¦®è­½æ¦œ</p>
                    <div class="rank-list" id="rank-content-start"></div>
                </div>
            </div>

            <div id="screen-select" class="overlay hidden">
                <h1>é¸æ“‡é—œå¡</h1>
                <p>å—¨ï¼Œ<span id="display-name" style="color:var(--brand-accent); font-weight:bold;"></span>ï¼æº–å‚™å¥½äº†å—ï¼Ÿ</p>
                <button class="btn" onclick="game.startLevel(1)">Lv 1ï¼šæ‰¾åŸºæº–é‡ <br><span style="font-size:0.8rem; font-weight:normal;">(åŸºç¤è­˜åˆ¥)</span></button>
                <button class="btn" onclick="game.startLevel(2)">Lv 2ï¼šæ‰¾æ¯”è¼ƒé‡ <br><span style="font-size:0.8rem; font-weight:normal;">(è­˜åˆ¥+èª¿æ•´æ•¸å€¼)</span></button>
                <button class="btn btn-blue" onclick="game.startLevel(3)">Lv 3ï¼šæ··åˆå¤§æŒ‘æˆ° <br><span style="font-size:0.8rem; font-weight:normal;">(éš¨æ©Ÿé¡Œå‹)</span></button>
            </div>

            <div id="screen-pause" class="overlay hidden">
                <h1>æš«åœä¸­ â¸ï¸</h1>
                <p>ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯</p>
                <button class="btn btn-green" onclick="game.togglePause()">ç¹¼çºŒéŠæˆ²</button>
                <button class="btn" onclick="game.restartLevel()">é‡æ–°æœ¬é—œ (åˆ†æ•¸æ­¸é›¶)</button>
                <button class="btn btn-blue" onclick="game.backToSelect()">å›é—œå¡é¸å–®</button>
            </div>

            <div id="screen-end" class="overlay hidden">
                <h1>æ™‚é–“åˆ°ï¼ğŸ””</h1>
                <div class="stars-container" id="final-stars">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <p>æœ€çµ‚åˆ†æ•¸ï¼š<span id="final-score" style="font-size:2.5rem; color:var(--brand-accent); font-weight:900;">0</span></p>
                
                <div class="rank-list" id="rank-content"></div>
                
                <div style="display:flex; flex-direction:column; gap:10px; width:100%; align-items:center;">
                    <button class="btn" onclick="game.restartLevel()"><i class="fas fa-redo"></i> å†ç©ä¸€æ¬¡</button>
                    <button class="btn btn-blue" onclick="game.backToSelect()"><i class="fas fa-list"></i> å›é¸æ“‡é—œå¡</button>
                </div>
            </div>

            <div class="hud">
                <div class="hud-group">
                    <div class="hud-item">
                        <span class="hud-label">å‰©é¤˜æ™‚é–“</span>
                        <span class="hud-value" id="time-disp">60</span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">åˆ†æ•¸</span>
                        <span class="hud-value" id="score-disp">0</span>
                    </div>
                </div>
                <div id="combo-box" class="combo-box">COMBO x2</div>
            </div>

            <div class="scenario-card">
                <i class="fas fa-balance-scale-left scenario-bg"></i>
                <div id="scenario-icon" style="width:100%;"></div>
            </div>

            <div class="question-area" id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <div class="hint-text" id="hint">æº–å‚™é–‹å§‹...</div>

            <div class="stage">
                <div class="char-box" id="char-A" onclick="game.handleClick('A')">
                    <div class="crown">ğŸ‘‘</div>
                    <div class="bar-model"><span class="emoji" id="emoji-A">ğŸ¶</span></div>
                    <div class="char-name" id="name-A">å°ç‹—</div>
                </div>
                <div class="char-box" id="char-B" onclick="game.handleClick('B')">
                    <div class="crown">ğŸ‘‘</div>
                    <div class="bar-model"><span class="emoji" id="emoji-B">ğŸ±</span></div>
                    <div class="char-name" id="name-B">å°è²“</div>
                </div>
            </div>

            <div class="control-panel" id="controls">
                <p style="color:var(--brand-accent); font-weight:bold; font-size:1.1rem; margin:0;">èª¿æ•´æ¯”è¼ƒé‡ï¼š<span class="val-display" id="slider-val">+0</span></p>
                <input type="range" id="slider" min="-5" max="5" step="1" value="0" oninput="game.updateSlider(this.value)">
                <br>
                <button class="btn btn-blue" style="font-size:1rem; padding:8px 30px; width:auto; min-width:120px; margin-top:5px;" onclick="game.submitSlider()">ç¢ºèªç­”æ¡ˆ</button>
            </div>

        </div>
    </div>

<script>
class MathGame {
    constructor() {
        this.playerName = "ç©å®¶";
        this.level = 1;
        this.score = 0;
        this.combo = 0; // é€£æ“Šæ•¸
        this.timeLeft = 60;
        this.timerInterval = null;
        this.leaderboard = this.loadLeaderboard();
        this.qData = null; 
        this.phase = 0; // 0: é¸åŸºæº–é‡, 1: èª¿æ»‘æ¡¿
        this.isPaused = false;
        
        this.renderLeaderboard('rank-content-start');
    }

    loadLeaderboard() {
        const saved = localStorage.getItem('jessieMath_base_rank');
        return saved ? JSON.parse(saved) : [];
    }

    saveLeaderboard() {
        localStorage.setItem('jessieMath_base_rank', JSON.stringify(this.leaderboard));
    }

    goToLevelSelect() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
        this.playerName = name;
        document.getElementById('display-name').innerText = name;
        
        this.showScreen('screen-select');
        document.getElementById('btn-pause').classList.add('hidden');
    }

    showScreen(screenId) {
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        if(screenId) {
            document.getElementById(screenId).classList.remove('hidden');
        }
    }

    startLevel(lvl) {
        this.level = lvl;
        this.score = 0;
        this.combo = 0;
        this.timeLeft = 60;
        this.isPaused = false;
        
        document.getElementById('score-disp').innerText = "0";
        this.updateComboUI();
        document.getElementById('time-disp').innerText = "60";
        document.getElementById('time-disp').classList.remove('urgent');
        
        this.showScreen(null); 
        document.getElementById('btn-pause').classList.remove('hidden');

        if(this.timerInterval) clearInterval(this.timerInterval);
        this.timerInterval = setInterval(() => {
            if (!this.isPaused) {
                this.timeLeft--;
                const timerEl = document.getElementById('time-disp');
                timerEl.innerText = this.timeLeft;
                if (this.timeLeft <= 10) timerEl.classList.add('urgent');
                if (this.timeLeft <= 0) this.endGame();
            }
        }, 1000);

        this.nextQuestion();
    }

    togglePause() {
        this.isPaused = !this.isPaused;
        const btn = document.getElementById('btn-pause');
        if (this.isPaused) {
            document.getElementById('screen-pause').classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            document.getElementById('screen-pause').classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-pause"></i>';
        }
    }

    restartLevel() {
        // é‡é–‹åŒé—œï¼Œåˆ†æ•¸æ­¸é›¶ï¼Œæ™‚é–“é‡ç½®
        this.startLevel(this.level);
    }

    backToSelect() {
        // å›ä¸»é¸å–®ï¼Œä¸å„²å­˜åˆ†æ•¸
        if(this.timerInterval) clearInterval(this.timerInterval);
        this.showScreen('screen-select');
        document.getElementById('btn-pause').classList.add('hidden');
    }

    nextQuestion() {
        this.resetUI();

        // é¡Œç›®è³‡æ–™åº«
        const roles = [
            {A:'å°ç‹—', B:'å°è²“', emojiA:'ğŸ¶', emojiB:'ğŸ±', unit:'éš»'}, 
            {A:'è˜‹æœ', B:'æ©˜å­', emojiA:'ğŸ', emojiB:'ğŸŠ', unit:'é¡†'}, 
            {A:'å“¥å“¥', B:'å¼Ÿå¼Ÿ', emojiA:'ğŸ‘¦', emojiB:'ğŸ‘¶', unit:'æ­²'},
            {A:'ç´…ç®±', B:'è—ç®±', emojiA:'ğŸŸ¥', emojiB:'ğŸŸ¦', unit:'å…¬æ–¤'},
            {A:'å­˜éŒ¢ç­’', B:'éŒ¢åŒ…', emojiA:'ğŸ·', emojiB:'ğŸ‘›', unit:'å…ƒ'},
            {A:'å…”å­', B:'çƒé¾œ', emojiA:'ğŸ°', emojiB:'ğŸ¢', unit:'éš»'},
            {A:'æ¼¢å ¡', B:'è–¯æ¢', emojiA:'ğŸ”', emojiB:'ğŸŸ', unit:'ä»½'},
            {A:'å¤§æ¨¹', B:'å°èŠ±', emojiA:'ğŸŒ²', emojiB:'ğŸŒ¸', unit:'æ£µ'},
            {A:'è¶³çƒ', B:'ç±ƒçƒ', emojiA:'âš½', emojiB:'ğŸ€', unit:'é¡†'},
            {A:'è›‹ç³•', B:'ç”œç”œåœˆ', emojiA:'ğŸ°', emojiB:'ğŸ©', unit:'å€‹'}
        ];
        const r = roles[Math.floor(Math.random()*roles.length)];
        
        // éš¨æ©Ÿæ±ºå®šèª°æ˜¯åŸºæº–é‡
        const isBaseA = Math.random() > 0.5;
        const baseObj = isBaseA ? 'A' : 'B';
        const targetObj = isBaseA ? 'B' : 'A';
        const baseName = isBaseA ? r.A : r.B;
        const targetName = isBaseA ? r.B : r.A;

        // æ±ºå®šé¡Œå‹ (å·®é‡ vs å€æ•¸)
        // Lv1 åªç©æ‰¾åŸºæº–é‡ï¼Œæ‰€ä»¥é€™è£¡ç”¢ç”Ÿé¡Œç›®é‚è¼¯ä¸€æ¨£
        // Lv3 éš¨æ©Ÿï¼ŒLv2 åå‘æ»‘æ¡¿æ“ä½œ
        let type = 'diff';
        if (this.level === 3) type = Math.random() > 0.5 ? 'diff' : 'ratio';
        else if (Math.random() > 0.7) type = 'ratio'; // Lv1,2 å¶çˆ¾å‡ºç¾å€æ•¸

        let val = 0;
        let qText = "";
        const templates = [];

        if (type === 'diff') {
            val = Math.floor(Math.random()*4) + 1;
            const isMore = Math.random() > 0.5;
            const opStr = isMore ? 'å¤š' : 'å°‘';
            const actionStr = isMore ? 'åŠ ä¸Š' : 'æ‰£æ‰';
            // é‚è¼¯å€¼
            const valSigned = isMore ? val : -val;

            templates.push(`${targetName} æ¯” ${baseName} <span class="highlight">${opStr} ${val} ${r.unit}</span>`);
            templates.push(`${targetName} çš„æ•¸é‡æ˜¯ ${baseName} <span class="highlight">${opStr} ${val} ${r.unit}</span>`);
            templates.push(`${baseName} å†<span class="highlight">${actionStr} ${val} ${r.unit}</span> å°±ç­‰æ–¼ ${targetName}`);
            
            qText = templates[Math.floor(Math.random() * templates.length)];
            val = valSigned;
        } else {
            val = Math.floor(Math.random()*3) + 2; 
            templates.push(`${targetName} æ˜¯ ${baseName} çš„ <span class="highlight">${val} å€</span>`);
            templates.push(`${targetName} çš„æ•¸é‡å‰›å¥½æ˜¯ ${baseName} çš„ <span class="highlight">${val} å€</span>`);
            templates.push(`${baseName} çš„ <span class="highlight">${val} å€</span> ç­‰æ–¼ ${targetName}`);
            qText = templates[Math.floor(Math.random() * templates.length)];
        }

        // æ›´æ–° UI
        document.getElementById('question-text').innerHTML = qText;
        document.getElementById('name-A').innerText = r.A;
        document.getElementById('emoji-A').innerText = r.emojiA;
        document.getElementById('name-B').innerText = r.B;
        document.getElementById('emoji-B').innerText = r.emojiB;
        
        // --- ä¿®æ­£çš„æƒ…å¢ƒåœ–é¡¯ç¤º ---
        // ä½¿ç”¨ Flexbox è®“å…©å€‹åœ–ç¤ºå·¦å³æ’åˆ—ï¼Œä¸­é–“åŠ ä¸Š vs ç¬¦è™Ÿï¼Œè§£æ±ºå¥‡æ€ªçš„æ’åˆ—å•é¡Œ
        const sceneHtml = `
            <div style="display:flex; justify-content:center; align-items:center; gap:25px;">
                <div style="font-size:3.5rem; animation: popIn 0.5s;">${r.emojiA}</div>
                <div style="font-size:1.5rem; color:#cbd5e0;"><i class="fas fa-exchange-alt"></i></div>
                <div style="font-size:3.5rem; animation: popIn 0.5s 0.2s backwards;">${r.emojiB}</div>
            </div>
        `;
        document.getElementById('scenario-icon').innerHTML = sceneHtml;

        this.qData = { base: baseObj, target: targetObj, type, val, baseName: baseName };

        // é—œå¡é‚è¼¯åˆ†æ­§
        if (this.level === 1) {
            this.phase = 0; 
            this.setHint("ğŸ‘‡ è«‹é»æ“Šã€ŒåŸºæº–é‡ã€ï¼ˆæ˜¯èª°åŸæœ¬å°±åœ¨é‚£ï¼Ÿï¼‰");
        } else if (this.level === 2) {
            // Lv2 å¯ä»¥è¨­è¨ˆæˆï¼šå…ˆæ‰¾åŸºæº–é‡ï¼Œå†èª¿æ»‘æ¡¿ (æ›´å®Œæ•´çš„æ•™å­¸æµç¨‹)
            this.phase = 0; 
            this.setHint("ç¬¬ 1 æ­¥ï¼šæ‰¾å‡ºåŸºæº–é‡");
        } else {
            this.phase = 0;
            this.setHint("æ··åˆæŒ‘æˆ°ï¼šæ‰¾å‡ºåŸºæº–é‡");
        }
    }

    resetUI() {
        document.getElementById('controls').style.display = 'none';
        document.getElementById('slider').value = 0;
        document.getElementById('slider-val').innerText = "+0";
        ['A', 'B'].forEach(id => {
            const el = document.getElementById('char-'+id);
            el.classList.remove('locked', 'dimmed');
            el.querySelector('.crown').style.display = 'none';
            const bar = el.querySelector('.bar-model');
            bar.style.height = ''; 
            bar.style.backgroundColor = '#bdc3c7';
        });
    }

    handleClick(id) {
        if (this.phase !== 0) return; 
        
        if (id === this.qData.base) {
            // ç­”å°åŸºæº–é‡
            this.visualizeBase(id);
            
            if (this.level === 1) {
                // Lv1 åªè¦æ‰¾å°å°±å¾—åˆ†æ›é¡Œ
                this.addScore(50);
                this.handleCorrect();
            } else {
                // Lv2 & Lv3 é€²å…¥ç¬¬äºŒéšæ®µï¼šæ»‘æ¡¿
                this.phase = 1;
                this.setHint("ç¬¬ 2 æ­¥ï¼šèª¿æ•´æ»‘æ¡¿ä¾†è¡¨ç¤ºé¡Œç›®æ„æ€", true);
                this.showSlider();
            }
        } else {
            // ç­”éŒ¯åŸºæº–é‡
            this.handleWrong(`åŸºæº–é‡å…¶å¯¦æ˜¯ ${this.qData.baseName} å–”ï¼`);
        }
    }

    visualizeBase(id) {
        const el = document.getElementById('char-'+id);
        el.querySelector('.crown').style.display = 'block';
        el.querySelector('.bar-model').style.backgroundColor = 'var(--brand-accent)';
        el.classList.add('locked'); 
        
        const other = id === 'A' ? 'B' : 'A';
        document.getElementById('char-'+other).classList.add('dimmed', 'locked');
    }

    showSlider() {
        const box = document.getElementById('controls');
        const slider = document.getElementById('slider');
        box.style.display = 'block';
        if (this.qData.type === 'ratio') {
            slider.min = 1; slider.max = 5; slider.step = 0.5; slider.value = 1;
        } else {
            slider.min = -5; slider.max = 5; slider.step = 1; slider.value = 0;
        }
        this.updateSlider(slider.value);
    }

    updateSlider(val) {
        const display = document.getElementById('slider-val');
        const targetBody = document.querySelector(`#char-${this.qData.target} .bar-model`);
        const baseH = window.innerWidth < 768 ? 50 : 80;
        let h = baseH;
        let txt = "";

        if (this.qData.type === 'ratio') {
            txt = `Ã— ${val}`;
            h = baseH * parseFloat(val);
        } else {
            const sign = val > 0 ? '+' : '';
            txt = `${sign}${val}`;
            const step = window.innerWidth < 768 ? 15 : 20;
            h = baseH + (parseInt(val) * step);
        }
        display.innerText = txt;
        targetBody.style.height = Math.max(20, h) + "px";
        targetBody.style.backgroundColor = 'var(--brand-primary)';
    }

    submitSlider() {
        const val = parseFloat(document.getElementById('slider').value);
        if (val === this.qData.val) {
            this.addScore(100);
            this.handleCorrect();
        } else {
            let ansText = "";
            if (this.qData.type === 'ratio') ansText = `Ã— ${this.qData.val}`;
            else ansText = (this.qData.val > 0 ? '+' : '') + this.qData.val;
            this.handleWrong(`æ•¸å€¼ä¸å°å–”ï¼æ­£ç¢ºæ‡‰è©²æ˜¯ ${ansText}`);
        }
    }

    handleCorrect() {
        this.combo++;
        this.updateComboUI();
        this.setHint(`ğŸ‰ æ­£ç¢ºï¼ (Combo x${this.combo})`, true);
        setTimeout(() => this.nextQuestion(), 1000);
    }

    handleWrong(msg) {
        this.combo = 0; // é‡ç½®é€£æ“Š
        this.updateComboUI();
        this.addScore(-10); // æ‰£åˆ†
        this.setHint(`âŒ ${msg}`, false);
        // æš«åœä¸€ä¸‹è®“å­¸ç”Ÿçœ‹éŒ¯èª¤è¨Šæ¯ï¼Œç„¶å¾Œæ›é¡Œ
        document.querySelectorAll('.char-box').forEach(el => el.classList.add('locked')); // é–ä½
        setTimeout(() => this.nextQuestion(), 2000); 
    }

    setHint(msg, isGood) {
        const el = document.getElementById('hint');
        el.innerText = msg;
        if (isGood === true) el.style.color = 'var(--correct)';
        else if (isGood === false) el.style.color = 'var(--wrong)';
        else el.style.color = '#7f8c8d';
    }

    addScore(points) {
        // é€£æ“ŠåŠ æˆï¼šæ¯å¤š 1 Combo å¤š 10% åˆ†æ•¸ (åƒ…æ­£åˆ†)
        let finalPoints = points;
        if (points > 0 && this.combo > 1) {
            finalPoints = Math.floor(points * (1 + (this.combo * 0.1)));
        }
        this.score += finalPoints;
        if (this.score < 0) this.score = 0;
        document.getElementById('score-disp').innerText = this.score;
    }
    
    updateComboUI() {
        const box = document.getElementById('combo-box');
        if (this.combo > 1) {
            box.innerText = `COMBO x${this.combo}`;
            box.classList.add('combo-active');
        } else {
            box.classList.remove('combo-active');
        }
    }

    endGame() {
        clearInterval(this.timerInterval);
        document.getElementById('btn-pause').classList.add('hidden'); 
        this.showScreen('screen-end');
        document.getElementById('final-score').innerText = this.score;
        
        // è¨ˆç®—æ˜Ÿæ˜Ÿ
        const starsEl = document.getElementById('final-stars');
        starsEl.innerHTML = '';
        let stars = 1;
        if (this.score > 500) stars = 2;
        if (this.score > 1000) stars = 3;
        
        for(let i=0; i<3; i++) {
            const s = document.createElement('i');
            s.className = 'fas fa-star star ' + (i < stars ? 'active' : '');
            starsEl.appendChild(s);
        }

        this.updateLeaderboard();
    }

    updateLeaderboard() {
        // åªæœ‰å¤§æ–¼ 0 åˆ†æ‰ç´€éŒ„
        if(this.score > 0) {
            this.leaderboard.push({name: this.playerName, score: this.score});
            this.leaderboard.sort((a,b) => b.score - a.score);
            // åªä¿ç•™å‰ 10
            if(this.leaderboard.length > 10) this.leaderboard = this.leaderboard.slice(0, 10);
            this.saveLeaderboard();
        }
        
        this.renderLeaderboard('rank-content'); 
        this.renderLeaderboard('rank-content-start');
    }

    renderLeaderboard(containerId) {
        const list = document.getElementById(containerId);
        if(!list) return;
        list.innerHTML = "";
        
        if (this.leaderboard.length === 0) {
            list.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">æš«ç„¡ç´€éŒ„</div>';
            return;
        }

        this.leaderboard.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = "rank-item";
            // é‡‘éŠ€éŠ…é¡è‰²
            let color = 'var(--brand-primary)';
            if(i===0) color='#f39c12';
            if(i===1) color='#7f8c8d';
            if(i===2) color='#d35400';
            
            div.innerHTML = `<span style="color:${color}">#${i+1} ${p.name}</span><span>${p.score}</span>`;
            list.appendChild(div);
        });
    }
}

const game = new MathGame();
</script>
</body>
</html>