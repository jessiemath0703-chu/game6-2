<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessie Math | 基準量大冒險</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #f39c12;    /* 品牌黃橘色 */
            --accent: #4a90e2;     /* 連結藍色 */
            --purple-btn: #5352ed; /* 主題按鈕紫 */
            --bg: #f8f9fa;
            --dark: #2c3e50;
            --header-h: 75px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
        body { background: var(--bg); color: var(--dark); padding-top: var(--header-h); }

        /* --- 1. Header (依照截圖復刻) --- */
        .header {
            position: fixed; top: 0; width: 100%; height: var(--header-h);
            background: white; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* Logo 區 */
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo-img {
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid var(--primary);
            background-image: url('JESSIEMATH-Q.png'); 
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center;
            background-color: #fff3cd; /* 預設底色 */
        }
        .logo-text { font-family: 'Fredoka One', cursive; font-size: 1.6rem; color: var(--dark); }

        /* 導覽按鈕區 */
        .nav-group { display: flex; align-items: center; gap: 12px; }
        
        .nav-btn {
            text-decoration: none; padding: 8px 16px; border-radius: 30px;
            font-size: 0.95rem; font-weight: bold; color: #555; border: 1px solid #ddd;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; background: white;
        }
        .nav-btn:hover { background: #f0f0f0; color: var(--accent); border-color: var(--accent); }
        
        /* 特殊樣式：回到六年級... */
        .nav-btn-outline {
            color: var(--purple-btn); border: 1.5px solid var(--purple-btn);
        }
        .nav-btn-outline:hover { background: #eff0ff; color: #3736b1; border-color: #3736b1; }

        /* --- Container --- */
        .container {
            max-width: 800px; margin: 30px auto; padding: 20px;
            background: white; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            min-height: 600px; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- Screens --- */
        .screen { display: none; flex-grow: 1; flex-direction: column; align-items: center; width: 100%; animation: fadeIn 0.3s; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Elements --- */
        .btn {
            padding: 12px 30px; border: none; border-radius: 50px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: 0.2s; margin: 10px; color: white; background: var(--dark);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); }
        
        .input-box {
            padding: 15px; border: 2px solid #ddd; border-radius: 15px;
            font-size: 1.2rem; width: 250px; text-align: center; margin-bottom: 20px;
        }

        /* Level Cards */
        .level-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; width: 100%; margin-top: 20px; }
        .level-card {
            background: white; border: 2px solid #eee; border-radius: 15px;
            padding: 20px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .level-card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .level-card i { font-size: 3rem; margin-bottom: 10px; color: var(--primary); }

        /* --- Game HUD --- */
        .hud {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            background: #f1f2f6; padding: 10px 20px; border-radius: 15px; margin-bottom: 10px;
        }
        .hud-stat { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .combo-text { color: #e74c3c; font-style: italic; font-weight: 900; transform: scale(0); transition: 0.2s; }
        .combo-text.show { transform: scale(1.2); }

        .timer-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
        .timer-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 1s linear; }

        /* --- Visual & Question --- */
        /* 情境插圖卡 */
        .context-card {
            width: 100px; height: 100px; 
            background: #fff8e1; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 3.5rem; color: var(--dark);
            margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            animation: popIn 0.5s;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .q-text { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; padding: 15px; width: 100%; text-align: center; line-height: 1.5; }
        .highlight { color: #e74c3c; text-decoration: underline; text-underline-offset: 4px; }

        /* Options Grid */
        .options-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; }
        .option-btn {
            background: white; border: 2px solid #ddd; padding: 20px;
            font-size: 1.3rem; font-weight: bold; cursor: pointer; border-radius: 12px;
            transition: 0.1s; color: #555;
        }
        .option-btn:hover { background: #fef9e7; border-color: var(--primary); color: var(--primary); }
        .option-btn:active { transform: scale(0.98); }

        /* --- Feedback & Pause --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 50;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }
        .feedback-text { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
        .correct-ans { font-size: 1.3rem; color: #666; margin-top: 10px; padding: 10px; background: #eee; border-radius: 10px;}

        /* Result Stars */
        .stars { font-size: 3rem; color: #ddd; margin: 10px 0; }
        .stars .filled { color: #f1c40f; }

        /* RWD */
        @media(max-width: 600px) {
            .header { padding: 0 10px; height: 60px; }
            .logo-text { font-size: 1.2rem; }
            .nav-btn span { display: none; } /* 手機版隱藏按鈕文字 */
            .nav-btn { padding: 8px; }
            .options-area { grid-template-columns: 1fr; }
            .q-text { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="brand">
            <div class="logo-img"></div>
            <div class="logo-text">Jessie Math</div>
        </div>
        <div class="nav-group">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn">
                <i class="fas fa-home"></i> <span>首頁</span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn">
                <i class="fas fa-gamepad"></i> <span>遊戲大廳</span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn nav-btn-outline">
                <i class="fas fa-chevron-left"></i> <span>六年級基準量與比較量</span>
            </a>
        </div>
    </header>

    <div class="container">
        
        <div id="screen-login" class="screen active" style="justify-content: center;">
            <div style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-balance-scale"></i></div>
            <h1 style="margin-bottom: 10px;">基準量大冒險</h1>
            <p style="color: #666; margin-bottom: 30px;">誰是基準？誰是比較？60秒極限挑戰！</p>
            <input type="text" id="username" class="input-box" placeholder="輸入你的名字" onkeydown="if(event.key==='Enter') goToMenu()">
            <button class="btn btn-primary" onclick="goToMenu()">開始挑戰</button>
        </div>

        <div id="screen-menu" class="screen">
            <h2 style="margin: 20px 0;">選擇挑戰關卡</h2>
            <p>嗨，<span id="display-name" style="color:var(--primary); font-weight:bold;">Player</span>！</p>
            
            <div class="level-grid">
                <div class="level-card" onclick="startGame(1)">
                    <i class="fas fa-search-location"></i>
                    <h3>L1. 誰是基準量？</h3>
                    <p>找出題目中被當作「1」的量</p>
                </div>
                <div class="level-card" onclick="startGame(2)">
                    <i class="fas fa-calculator"></i>
                    <h3>L2. 計算比較量</h3>
                    <p>已知基準量，求比較量</p>
                </div>
                <div class="level-card" onclick="startGame(3)">
                    <i class="fas fa-percent"></i>
                    <h3>L3. 比值大亂鬥</h3>
                    <p>計算比值與母子和/差</p>
                </div>
            </div>

            <div style="margin-top: 30px; width: 100%; background: #fff8e1; padding: 15px; border-radius: 10px;">
                <h4><i class="fas fa-trophy"></i> 本機排行榜</h4>
                <div id="leaderboard" style="text-align: left; padding: 10px;"></div>
            </div>
        </div>

        <div id="screen-game" class="screen">
            <div id="pause-overlay" class="overlay">
                <i class="fas fa-pause-circle" style="font-size: 5rem; color: var(--primary); margin-bottom: 20px;"></i>
                <h2>遊戲暫停</h2>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="togglePause()">繼續</button>
                    <button class="btn" onclick="quitToMenu()" style="background:#e74c3c;">回選單</button>
                </div>
            </div>

            <div id="feedback-overlay" class="overlay" style="background: rgba(255,255,255,0.95);">
                <div id="fb-icon" style="font-size: 4rem; margin-bottom: 10px;"></div>
                <div id="fb-text" class="feedback-text"></div>
                <div id="fb-ans" class="correct-ans"></div>
            </div>

            <div class="hud">
                <div class="hud-stat" style="color:#f39c12"><i class="fas fa-star"></i> <span id="score-val">0</span></div>
                <div class="hud-stat" style="color:#2c3e50"><i class="fas fa-stopwatch"></i> <span id="time-val">60</span>s</div>
                <div id="combo-display" class="combo-text">Combo x0</div>
                <div>
                    <button onclick="togglePause()" style="border:none; background:white; width:40px; height:40px; border-radius:50%; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);"><i class="fas fa-pause"></i></button>
                </div>
            </div>
            
            <div class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>

            <div id="context-card" class="context-card">
                <i class="fas fa-question"></i>
            </div>

            <div class="q-text" id="question-text">題目載入中...</div>

            <div class="options-area" id="options-container">
                </div>
        </div>

        <div id="screen-result" class="screen" style="justify-content: center;">
            <h2 style="color: #666;">Time's Up!</h2>
            <div class="stars" id="result-stars">
                <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
            </div>
            <h1 style="font-size: 3.5rem; color: var(--primary); margin: 10px 0;"><span id="final-score">0</span> 分</h1>
            <p>Max Combo: <span id="final-combo">0</span></p>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn" onclick="goToMenu()" style="background: #95a5a6;">回選單</button>
                <button class="btn btn-primary" onclick="restartLevel()">再玩一次</button>
            </div>
        </div>

    </div>

    <script>
        // --- 遊戲核心資料與狀態 ---
        const Game = {
            user: "Player",
            level: 1,
            score: 0,
            time: 60,
            timer: null,
            paused: false,
            combo: 0,
            maxCombo: 0,
            currentQ: null
        };

        // --- 導航與介面控制 ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
        }

        function goToMenu() {
            const input = document.getElementById('username').value.trim();
            if(input) Game.user = input;
            document.getElementById('display-name').innerText = Game.user;
            updateLeaderboardView();
            showScreen('menu');
        }

        function quitToMenu() {
            clearInterval(Game.timer);
            showScreen('menu');
        }

        // --- 遊戲邏輯 ---
        function startGame(lvl) {
            Game.level = lvl;
            restartLevel();
        }

        function restartLevel() {
            // 重置狀態
            Game.score = 0;
            Game.time = 60;
            Game.combo = 0;
            Game.maxCombo = 0;
            Game.paused = false;
            
            document.getElementById('pause-overlay').classList.remove('active');
            document.getElementById('feedback-overlay').classList.remove('active');
            
            updateHUD();
            showScreen('game');
            nextQuestion();

            // 啟動計時器
            if(Game.timer) clearInterval(Game.timer);
            Game.timer = setInterval(() => {
                if(!Game.paused) {
                    Game.time--;
                    updateHUD();
                    if(Game.time <= 0) endGame();
                }
            }, 1000);
        }

        function togglePause() {
            if(Game.time <= 0) return;
            Game.paused = !Game.paused;
            const overlay = document.getElementById('pause-overlay');
            if(Game.paused) overlay.classList.add('active');
            else overlay.classList.remove('active');
        }

        function updateHUD() {
            document.getElementById('score-val').innerText = Game.score;
            document.getElementById('time-val').innerText = Game.time;
            
            const pct = (Game.time / 60) * 100;
            const bar = document.getElementById('timer-fill');
            bar.style.width = pct + "%";
            bar.style.background = pct < 20 ? "#e74c3c" : "#2ecc71";

            const comboEl = document.getElementById('combo-display');
            if(Game.combo >= 2) {
                comboEl.innerText = `Combo x${Game.combo}`;
                comboEl.classList.add('show');
            } else {
                comboEl.classList.remove('show');
            }
        }

        // --- 題目生成系統 ---
        function nextQuestion() {
            const context = getRandomContext();
            let qText = "", correctAns = "", options = [], iconClass = context.icon;

            // 隨機數值生成
            const baseVal = Math.floor(Math.random() * 8) + 2; // 基準量 2~10
            const ratio = Math.floor(Math.random() * 4) + 2;   // 比值 2~5
            const compVal = baseVal * ratio; // 比較量

            // 根據關卡生成題目
            if(Game.level === 1) {
                // L1: 找基準量 (文字理解)
                // 題型：A是B的3倍，誰是基準量？
                // 題型：甲的錢是乙的0.5倍，誰是基準量？
                const isTypeA = Math.random() > 0.5;
                if(isTypeA) {
                    qText = `${context.A}的數量是${context.B}的 <span class="highlight">${ratio}倍</span>。<br>請問誰是<b>基準量</b>？`;
                    correctAns = context.B;
                    options = [context.A, context.B, "都是", "都不是"];
                } else {
                    qText = `${context.A}是${context.B}的 <span class="highlight">${ratio}倍</span>。<br>請問誰是<b>比較量</b>？`;
                    correctAns = context.A;
                    options = [context.A, context.B, "無法判斷", "一樣大"];
                }
            } else if (Game.level === 2) {
                // L2: 計算比較量/基準量
                const mode = Math.random();
                if(mode > 0.5) {
                    // 求比較量: 已知基準量B=baseVal, 比值=ratio
                    qText = `${context.B}有 ${baseVal} 個，${context.A}是${context.B}的 ${ratio} 倍。<br>請問${context.A}有幾個？`;
                    correctAns = compVal;
                } else {
                    // 求基準量: 已知比較量A=compVal, 比值=ratio
                    qText = `${context.A}有 ${compVal} 個，${context.A}是${context.B}的 ${ratio} 倍。<br>請問${context.B}有幾個？`;
                    correctAns = baseVal;
                }
                options = generateNumberOptions(correctAns);
            } else {
                // L3: 混合題 (母子和/差)
                // 題型：甲乙和=sum，甲是乙的ratio倍。求乙(基準量)
                const sum = baseVal + compVal;
                const diff = compVal - baseVal;
                
                if(Math.random() > 0.5) {
                    qText = `${context.A}和${context.B}共有 ${sum} 個，${context.A}是${context.B}的 ${ratio} 倍。<br>請問${context.B} (基準量) 有幾個？`;
                    correctAns = baseVal;
                } else {
                    qText = `${context.A}比${context.B}多 ${diff} 個，${context.A}是${context.B}的 ${ratio} 倍。<br>請問${context.B}有幾個？`;
                    correctAns = baseVal;
                }
                options = generateNumberOptions(correctAns);
            }

            // 更新 UI
            document.getElementById('context-card').innerHTML = `<i class="${iconClass}"></i>`;
            document.getElementById('question-text').innerHTML = qText;
            
            Game.currentQ = { ans: correctAns };
            renderOptions(options);
        }

        function getRandomContext() {
            const contexts = [
                { A: "蘋果", B: "橘子", icon: "fas fa-apple-alt" },
                { A: "哥哥的錢", B: "弟弟的錢", icon: "fas fa-wallet" },
                { A: "紅繩", B: "藍繩", icon: "fas fa-ruler" },
                { A: "大狗體重", B: "小貓體重", icon: "fas fa-weight" },
                { A: "甲班人數", B: "乙班人數", icon: "fas fa-users" }
            ];
            return contexts[Math.floor(Math.random() * contexts.length)];
        }

        function generateNumberOptions(correct) {
            let opts = new Set();
            opts.add(correct);
            while(opts.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5;
                let val = correct + offset;
                if(val > 0 && val !== correct) opts.add(val);
            }
            return Array.from(opts).sort(() => Math.random() - 0.5);
        }

        function renderOptions(options) {
            const container = document.getElementById('options-container');
            container.innerHTML = "";
            options.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt);
                container.appendChild(btn);
            });
        }

        function checkAnswer(val) {
            if(Game.paused) return;

            const isCorrect = (val == Game.currentQ.ans);
            showFeedback(isCorrect, Game.currentQ.ans);

            if(isCorrect) {
                Game.combo++;
                if(Game.combo > Game.maxCombo) Game.maxCombo = Game.combo;
                let pts = 100 + (Game.combo > 1 ? (Game.combo * 10) : 0);
                Game.score += pts;
            } else {
                Game.combo = 0;
            }
            updateHUD();
        }

        function showFeedback(isCorrect, correctVal) {
            Game.paused = true; // 暫停
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const ans = document.getElementById('fb-ans');

            overlay.classList.add('active');
            
            if(isCorrect) {
                icon.innerHTML = '<i class="fas fa-check-circle" style="color:#2ecc71;"></i>';
                text.innerText = "答對了！";
                text.style.color = "#2ecc71";
                ans.style.display = "none";
            } else {
                icon.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i>';
                text.innerText = "答錯囉...";
                text.style.color = "#e74c3c";
                ans.style.display = "block";
                ans.innerText = `正確答案是：${correctVal}`;
            }

            // 1.5秒後下一題
            setTimeout(() => {
                overlay.classList.remove('active');
                Game.paused = false; 
                if(Game.time > 0) nextQuestion();
            }, 1500);
        }

        // --- 結算與榜單 ---
        function endGame() {
            clearInterval(Game.timer);
            showScreen('result');
            document.getElementById('final-score').innerText = Game.score;
            document.getElementById('final-combo').innerText = Game.maxCombo;

            // 星星判定
            let stars = 1;
            if(Game.score > 800) stars = 2;
            if(Game.score > 1500) stars = 3;
            
            let html = "";
            for(let i=0; i<3; i++) {
                html += i < stars ? '<i class="fas fa-star filled"></i>' : '<i class="far fa-star"></i>';
            }
            document.getElementById('result-stars').innerHTML = html;

            saveScore();
        }

        function saveScore() {
            let data = JSON.parse(localStorage.getItem('jessieMath_BaseQty_Rank')) || [];
            if(Game.score > 0) {
                data.push({ name: Game.user, score: Game.score });
                data.sort((a,b) => b.score - a.score);
                data = data.slice(0, 5); // 取前5
                localStorage.setItem('jessieMath_BaseQty_Rank', JSON.stringify(data));
            }
        }

        function updateLeaderboardView() {
            let data = JSON.parse(localStorage.getItem('jessieMath_BaseQty_Rank')) || [];
            let html = "";
            data.forEach((d, i) => {
                html += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span><i class="fas fa-crown" style="color:#f1c40f; margin-right:5px;"></i>${i+1}. ${d.name}</span> <b>${d.score}</b>
                </div>`;
            });
            if(!html) html = "<div style='color:#999;'>暫無紀錄，快來挑戰！</div>";
            document.getElementById('leaderboard').innerHTML = html;
        }

    </script>
</body>
</html>